(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=i(o);fetch(o.href,a)}})();const U="YOUR_CLIENT_ID",e={currentMode:"record",isRecording:!1,voskSocket:null,audioContext:null,mediaStream:null,processor:null,recordingStartTime:0,recordingTimer:null,currentAudioFile:null,transcriptText:"",translationText:"",translationDebounce:null,voskUrl:localStorage.getItem("voskUrl")||"ws://localhost:2700",libreUrl:localStorage.getItem("libreUrl")||"https://libretranslate.com",recognition:null,useWebSpeechAPI:localStorage.getItem("useWebSpeechAPI")==="true"||!1,tokenClient:null,accessToken:null,pickerInited:!1,gisInited:!1},t={recordModeBtn:document.getElementById("recordModeBtn"),uploadModeBtn:document.getElementById("uploadModeBtn"),recordMode:document.getElementById("recordMode"),uploadMode:document.getElementById("uploadMode"),recordBtn:document.getElementById("recordBtn"),recordStatus:document.getElementById("recordStatus"),recordingInfo:document.getElementById("recordingInfo"),recordTimer:document.getElementById("recordTimer"),uploadZone:document.getElementById("uploadZone"),fileInput:document.getElementById("fileInput"),uploadProgress:document.getElementById("uploadProgress"),fileName:document.getElementById("fileName"),fileSize:document.getElementById("fileSize"),progressFill:document.getElementById("progressFill"),transcribeBtn:document.getElementById("transcribeBtn"),googleDriveBtn:document.getElementById("googleDriveBtn"),languageSelect:document.getElementById("languageSelect"),originalLanguageLabel:document.getElementById("originalLanguageLabel"),settingsBtn:document.getElementById("settingsBtn"),settingsModal:document.getElementById("settingsModal"),closeSettingsBtn:document.getElementById("closeSettingsBtn"),saveSettingsBtn:document.getElementById("saveSettingsBtn"),voskUrlInput:document.getElementById("voskUrl"),libreUrlInput:document.getElementById("libreUrl"),outputSection:document.getElementById("outputSection"),transcriptText:document.getElementById("transcriptText"),translationText:document.getElementById("translationText"),translationStatus:document.getElementById("translationStatus"),wordCount:document.getElementById("wordCount"),charCount:document.getElementById("charCount"),copyBtn:document.getElementById("copyBtn"),downloadBtn:document.getElementById("downloadBtn"),clearBtn:document.getElementById("clearBtn"),toast:document.getElementById("toast"),toastMessage:document.getElementById("toastMessage")};function P(){R(),T(),C(),D(),typeof gapi<"u"&&gapi.load("picker",q),typeof google<"u"&&Y()}function R(){t.recordModeBtn.addEventListener("click",()=>B("record")),t.uploadModeBtn.addEventListener("click",()=>B("upload")),t.recordBtn.addEventListener("click",V),t.uploadZone.addEventListener("click",n=>{n.target!==t.googleDriveBtn&&!t.googleDriveBtn.contains(n.target)&&t.fileInput.click()}),t.uploadZone.addEventListener("dragover",n=>{n.preventDefault(),t.uploadZone.classList.add("drag-over")}),t.uploadZone.addEventListener("dragleave",()=>{t.uploadZone.classList.remove("drag-over")}),t.uploadZone.addEventListener("drop",z),t.fileInput.addEventListener("change",G),t.transcribeBtn.addEventListener("click",Z),t.googleDriveBtn.addEventListener("click",Q),t.settingsBtn.addEventListener("click",A),t.closeSettingsBtn.addEventListener("click",x),t.saveSettingsBtn.addEventListener("click",F),t.settingsModal.addEventListener("click",n=>{n.target===t.settingsModal&&x()}),t.copyBtn.addEventListener("click",j),t.downloadBtn.addEventListener("click",J),t.clearBtn.addEventListener("click",K),t.languageSelect.addEventListener("change",C),t.transcriptText.addEventListener("input",T)}function D(){t.voskUrlInput.value=e.voskUrl,t.libreUrlInput.value=e.libreUrl}function A(){t.settingsModal.classList.add("active")}function x(){t.settingsModal.classList.remove("active")}function F(){e.voskUrl=t.voskUrlInput.value.trim(),e.libreUrl=t.libreUrlInput.value.trim(),e.libreUrl.endsWith("/")&&(e.libreUrl=e.libreUrl.slice(0,-1)),localStorage.setItem("voskUrl",e.voskUrl),localStorage.setItem("libreUrl",e.libreUrl),x(),l("Settings saved!","success")}function B(n){e.currentMode=n,t.recordModeBtn.classList.toggle("active",n==="record"),t.uploadModeBtn.classList.toggle("active",n==="upload"),n==="record"?(t.recordMode.classList.add("active"),t.uploadMode.classList.remove("active")):(t.recordMode.classList.remove("active"),t.uploadMode.classList.add("active"),v())}function C(){const n=t.languageSelect.value==="bs";t.originalLanguageLabel.textContent=n?"üáßüá¶ Bosnian (Original)":"üá∫üá∏ English (Original)"}async function O(){b()?k():$()}function b(){return"webkitSpeechRecognition"in window||"SpeechRecognition"in window}function k(){try{const n=window.SpeechRecognition||window.webkitSpeechRecognition;e.recognition=new n;const r=t.languageSelect.value==="bs";e.recognition.lang=r?"bs-BA":"en-US",e.recognition.continuous=!0,e.recognition.interimResults=!0,e.isRecording=!0,e.transcriptText="",e.translationText="",f(""),t.translationText.textContent="",t.recordBtn.classList.add("recording"),t.recordStatus.textContent="Listening... (Browser Speech)",t.recordingInfo.classList.add("active"),e.recordingStartTime=Date.now(),e.recordingTimer=setInterval(y,1e3),e.recognition.onresult=i=>{let s="",o="";for(let a=i.resultIndex;a<i.results.length;a++){const c=i.results[a][0].transcript;i.results[a].isFinal?s+=c+" ":o+=c}s&&(e.transcriptText+=s,f(e.transcriptText),t.languageSelect.value==="bs"&&w(s)),o&&f(e.transcriptText+o)},e.recognition.onerror=i=>{console.error("Speech Recognition Error:",i.error),i.error==="not-allowed"?l("Microphone access denied. Please allow microphone access.","error"):i.error==="network"?l("Network error. Check your internet connection.","error"):i.error==="no-speech"?console.log("No speech detected, continuing..."):l(`Speech recognition error: ${i.error}`,"error")},e.recognition.onend=()=>{if(e.isRecording)try{e.recognition.start()}catch(i){console.log("Recognition restart skipped:",i.message)}},e.recognition.start(),console.log("Started Web Speech API recognition"),l("üé§ Listening... (using browser speech recognition)","success")}catch(n){console.error("Web Speech API Error:",n),l("Speech recognition failed. Try Chrome or Edge browser.","error"),v()}}async function $(){try{e.audioContext=new(window.AudioContext||window.webkitAudioContext),e.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),e.voskSocket=new WebSocket(e.voskUrl),e.voskSocket.onopen=()=>{console.log("Connected to Vosk Server"),N(),e.isRecording=!0,e.transcriptText="",e.translationText="",f(""),t.translationText.textContent="",t.recordBtn.classList.add("recording"),t.recordStatus.textContent="Listening... (Vosk Server)",t.recordingInfo.classList.add("active"),e.recordingStartTime=Date.now(),e.recordingTimer=setInterval(y,1e3)},e.voskSocket.onmessage=n=>{const r=JSON.parse(n.data);if(r.partial,r.text){const i=r.text;i&&i.length>0&&(e.transcriptText+=i+" ",f(e.transcriptText),t.languageSelect.value==="bs"&&w(i))}},e.voskSocket.onerror=n=>{console.error("Vosk WebSocket Error:",n),console.error("Attempted to connect to:",e.voskUrl),l("Cannot connect to Vosk server. Trying browser speech...","warning"),e.mediaStream&&(e.mediaStream.getTracks().forEach(r=>r.stop()),e.mediaStream=null),e.audioContext&&(e.audioContext.close(),e.audioContext=null),b()?k():l("No speech recognition available. Use Chrome/Edge browser.","error")},e.voskSocket.onclose=()=>{console.log("Vosk WebSocket Closed"),e.isRecording&&v()}}catch(n){console.error("Microphone Error:",n),l("Microphone access denied or error.","error")}}function N(){const n=e.audioContext.createMediaStreamSource(e.mediaStream),r=4096;e.processor=e.audioContext.createScriptProcessor(r,1,1),n.connect(e.processor),e.processor.connect(e.audioContext.destination),e.processor.onaudioprocess=i=>{if(!e.voskSocket||e.voskSocket.readyState!==WebSocket.OPEN)return;const s=i.inputBuffer.getChannelData(0),a=W(s,e.audioContext.sampleRate,16e3),c=L(a);e.voskSocket.send(c)}}function v(){if(e.isRecording){if(e.isRecording=!1,t.recordBtn.classList.remove("recording"),t.recordStatus.textContent="Tap to start recording",t.recordingInfo.classList.remove("active"),e.recognition){try{e.recognition.stop()}catch(n){console.log("Recognition stop error:",n.message)}e.recognition=null}e.voskSocket&&(e.voskSocket.close(),e.voskSocket=null),e.mediaStream&&(e.mediaStream.getTracks().forEach(n=>n.stop()),e.mediaStream=null),e.processor&&(e.processor.disconnect(),e.processor=null),e.audioContext&&(e.audioContext.close(),e.audioContext=null),clearInterval(e.recordingTimer),t.recordTimer.textContent="0:00"}}function V(){e.isRecording?v():O()}function y(){const n=Math.floor((Date.now()-e.recordingStartTime)/1e3),r=Math.floor(n/60),i=n%60;t.recordTimer.textContent=`${r}:${i.toString().padStart(2,"0")}`}function W(n,r,i){if(i==r)return n;if(i>r)throw"downsampling rate show be smaller than original sample rate";for(var s=r/i,o=Math.round(n.length/s),a=new Float32Array(o),c=0,g=0;c<a.length;){for(var m=Math.round((c+1)*s),p=0,u=0,d=g;d<m&&d<n.length;d++)p+=n[d],u++;a[c]=p/u,c++,g=m}return a}function L(n){for(var r=new ArrayBuffer(n.length*2),i=new DataView(r),s=0;s<n.length;s++){var o=Math.max(-1,Math.min(1,n[s]));i.setInt16(s*2,o<0?o*32768:o*32767,!0)}return r}async function w(n,r=!1){if(!n||n.trim().length===0)return;const i=async()=>{try{if(t.translationStatus.classList.add("active"),!e.libreUrl)throw new Error("LibreTranslate URL not configured. Please check settings.");let s;try{s=await fetch(`${e.libreUrl}/translate`,{method:"POST",body:JSON.stringify({q:n,source:"bs",target:"en",format:"text"}),headers:{"Content-Type":"application/json"}})}catch(a){throw console.error("Network error connecting to LibreTranslate:",a),new Error(`Cannot reach LibreTranslate server at ${e.libreUrl}. Is it running?`)}if(!s.ok){const a=await s.text().catch(()=>"Unknown error");throw console.error("LibreTranslate HTTP error:",s.status,a),new Error(`Translation failed (HTTP ${s.status}): ${s.statusText}`)}let o;try{o=await s.json()}catch(a){throw console.error("Failed to parse translation response:",a),new Error("Invalid response from translation server")}if(o.error)throw console.error("LibreTranslate API error:",o.error),new Error(`Translation error: ${o.error}`);if(o.translatedText)if(r)e.translationText=o.translatedText,t.translationText.textContent=o.translatedText;else{const a=t.translationText.textContent,c=a?a+" "+o.translatedText:o.translatedText;e.translationText=c,t.translationText.textContent=c}else console.warn("Translation response missing translatedText:",o)}catch(s){console.error("LibreTranslate Error:",s),l(`Translation failed: ${s.message}`,"error")}finally{t.translationStatus.classList.remove("active")}};r?await i():(clearTimeout(e.translationDebounce),e.translationDebounce=setTimeout(i,1e3))}async function Z(){if(e.currentAudioFile){if(!e.voskUrl){l("Please configure Vosk URL in settings","error");return}t.transcribeBtn.disabled=!0,t.transcribeBtn.classList.add("processing"),h(0,"Preparing...");try{const n=await e.currentAudioFile.arrayBuffer(),i=await new(window.AudioContext||window.webkitAudioContext)().decodeAudioData(n),s=new OfflineAudioContext(1,i.duration*16e3,16e3),o=s.createBufferSource();o.buffer=i,o.connect(s.destination),o.start();const c=(await s.startRendering()).getChannelData(0),g=new WebSocket(e.voskUrl);h(10,"Connecting to server..."),await new Promise((u,d)=>{g.onopen=u,g.onerror=d}),h(20,"Transcribing...");const m=4096;let p=0;for(g.onmessage=u=>{const d=JSON.parse(u.data);d.text&&(e.transcriptText+=d.text+" ",f(e.transcriptText))};p<c.length;){const u=Math.min(p+m,c.length),d=c.slice(p,u),I=L(d);if(g.send(I),p+=m,p%(m*10)===0){const S=Math.round(p/c.length*100);h(S,`Transcribing ${S}%...`),await new Promise(M=>setTimeout(M,10))}}g.send('{"eof" : 1}'),await new Promise(u=>setTimeout(u,2e3)),g.close(),h(100,"Complete!"),l("‚úÖ Transcription complete!","success"),t.languageSelect.value==="bs"&&(h(100,"Translating..."),await w(e.transcriptText,!0))}catch(n){console.error("Transcription error:",n),l("‚ùå Failed: "+n.message,"error")}finally{setTimeout(_,1e3)}}}function z(n){n.preventDefault(),t.uploadZone.classList.remove("drag-over");const r=n.dataTransfer.files[0];r&&r.type.startsWith("audio/")?E(r):l("Please upload an audio file","error")}function G(n){const r=n.target.files[0];r&&E(r)}function E(n){e.currentAudioFile=n,t.fileName.textContent=n.name,t.fileSize.textContent=H(n.size),t.uploadProgress.classList.add("active"),t.uploadProgress.style.display="block",t.transcribeBtn.disabled=!1,t.progressFill.style.width="0%",e.transcriptText="",e.translationText="",f(""),t.translationText.textContent=""}function h(n,r){t.transcribeBtn.innerHTML=`
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="animation: spin 1s linear infinite;">
            <path d="M10 3C10.5523 3 11 3.44772 11 4V6C11 6.55228 10.5523 7 10 7C9.44772 7 9 6.55228 9 6V4C9 3.44772 9.44772 3 10 3Z"/>
            <path opacity="0.3" d="M10 13C10.5523 13 11 13.4477 11 14V16C11 16.5523 10.5523 17 10 17C9.44772 17 9 16.5523 9 16V14C9 13.4477 9.44772 13 10 13Z"/>
        </svg>
        ${r}
    `,t.uploadProgress.classList.contains("active")&&(t.progressFill.style.width=`${n}%`)}function _(){t.transcribeBtn.disabled=!1,t.transcribeBtn.classList.remove("processing"),t.transcribeBtn.innerHTML=`
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 3C10.5523 3 11 3.44772 11 4V9.58579L13.2929 7.29289C13.6834 6.90237 14.3166 6.90237 14.7071 7.29289C15.0976 7.68342 15.0976 8.31658 14.7071 8.70711L10.7071 12.7071C10.3166 13.0976 9.68342 13.0976 9.29289 12.7071L5.29289 8.70711C4.90237 8.31658 4.90237 7.68342 5.29289 7.29289C5.68342 6.90237 6.31658 6.90237 6.70711 7.29289L9 9.58579V4C9 3.44772 9.44772 3 10 3Z"/>
            <path d="M4 13C4.55228 13 5 13.4477 5 14C5 14.5523 5.44772 15 6 15H14C14.5523 15 15 14.5523 15 15V14C15 13.4477 15.4477 13 16 13C16.5523 13 17 13.4477 17 14C17 15.6569 15.6569 17 14 17H6C4.34315 17 3 15.6569 3 15V14C3 13.4477 3.44772 13 4 13Z"/>
        </svg>
        Transcribe Audio
    `}function H(n){if(n===0)return"0 Bytes";const r=1024,i=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(n)/Math.log(r));return parseFloat((n/Math.pow(r,s)).toFixed(2))+" "+i[s]}function l(n,r="success"){t.toastMessage.textContent=n,t.toast.className=`toast show ${r}`,setTimeout(()=>{t.toast.classList.remove("show")},3e3)}function f(n){t.transcriptText.textContent=n,T()}function T(){const n=t.transcriptText.textContent||"";t.wordCount.textContent=n.trim()?n.trim().split(/\s+/).length:0,t.charCount.textContent=n.length}function j(){const n=t.transcriptText.textContent,r=t.translationText.textContent,i=t.languageSelect.value==="bs"&&r?`Original:
${n}

Translation:
${r}`:n;navigator.clipboard.writeText(i).then(()=>l("‚úÖ Copied!","success")).catch(()=>l("‚ùå Failed to copy","error"))}function J(){const n=t.transcriptText.textContent,r=t.translationText.textContent,i=t.languageSelect.value==="bs"&&r?`Original:
${n}

Translation:
${r}`:n,s=new Blob([i],{type:"text/plain"}),o=URL.createObjectURL(s),a=document.createElement("a");a.href=o,a.download=`transcript-${Date.now()}.txt`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}function K(){confirm("Clear all text?")&&(t.transcriptText.textContent="",t.translationText.textContent="",e.transcriptText="",e.translationText="",T())}function q(){e.pickerInited=!0}function Y(){e.tokenClient=google.accounts.oauth2.initTokenClient({client_id:U,scope:"https://www.googleapis.com/auth/drive.readonly",callback:""}),e.gisInited=!0}function Q(){{alert("Please configure GOOGLE_API_KEY in app.js");return}}P();
